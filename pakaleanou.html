<!DOCTYPE html>
<html>
<head>
    <title>Χάρτης Πακαλεάνου - Γιάννος</title>
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        #map {
            height: 70vh;
            width: 100%;
        }
        .table-container {
            max-height: 300px;
            overflow-y: auto;
            width: 100%;
            position: relative;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
            font-family: Arial, sans-serif;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
            font-weight: bold;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        td {
            background-color: #fff;
        }
        tr:nth-child(even) td {
            background-color: #f9f9f9;
        }
        tr:hover td {
            background-color: #f5f5f5;
        }
        .highlighted td {
            background-color: #ffff99 !important;
        }
    </style>
</head>
<body>
    <div id="map"></div>
    <div class="table-container" id="table-container">
        <table id="locations-table">
            <thead>
                <tr>
                    <th>ΑΑ</th>
                    <th>Διεύθυνση</th>
                </tr>
            </thead>
            <tbody id="table-body"></tbody>
        </table>
    </div>
    <script>
        async function initMap() {
            // Φόρτωση API key (αντικατέστησε με το δικό σου endpoint ή πρόσθεσε το API key απευθείας)
            let apiKey;
            try {
                const response = await fetch('/.netlify/functions/get-api-key'); // Προσαρμόστε το URL
                const data = await response.json();
                apiKey = data.apiKey;
            } catch (error) {
                console.error("Failed to load API key:", error);
                apiKey = 'AIzaSyBGNEgkzo-9QKOAvy2fo7fVGSnmqviyKcM'; // Αντικατέστησε με το API key σου για δοκιμή
            }

            // Φόρτωση Google Maps API
            const script = document.createElement('script');
            script.src = `https://maps.googleapis.com/maps/api/js?key=${apiKey}&callback=initMapCallback`;
            script.async = true;
            document.head.appendChild(script);

            // Callback για το Google Maps
            window.initMapCallback = async function() {
                const map = new google.maps.Map(document.getElementById("map"), {
                    zoom: 12,
                    center: { lat: 38.1356291, lng: 23.8257552 }
                });

                // Φόρτωση δεδομένων από JSON
                let locations = [];
                try {
                    const response = await fetch('locations.json');
                    locations = await response.json();
                } catch (error) {
                    console.error("Failed to load locations.json:", error);
                    return;
                }

                let currentInfoWindow = null;
                let currentMarker = null;
                const markers = [];

                const defaultIcon = {
                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    scaledSize: new google.maps.Size(32, 32),
                    labelOrigin: new google.maps.Point(16, 40)
                };
                const enlargedIcon = {
                    url: "http://maps.google.com/mapfiles/ms/icons/red-dot.png",
                    scaledSize: new google.maps.Size(41.6, 41.6),
                    labelOrigin: new google.maps.Point(20.8, 52)
                };

                function geocodeAddress(address, callback) {
                    const geocoder = new google.maps.Geocoder();
                    geocoder.geocode({ address: address }, (results, status) => {
                        if (status === "OK") {
                            callback(results[0].geometry.location);
                        } else {
                            console.error("Geocoding failed for address " + address + ": " + status);
                            callback(null);
                        }
                    });
                }

                locations.forEach((location, index) => {
                    if (location.address && typeof location.address === 'string') {
                        geocodeAddress(location.address, (coords) => {
                            if (coords) {
                                const marker = new google.maps.Marker({
                                    position: coords,
                                    map: map,
                                    title: location.title,
                                    label: {
                                        text: location.label,
                                        color: "black",
                                        fontSize: "14px",
                                        fontWeight: "bold"
                                    },
                                    icon: defaultIcon,
                                    zIndex: 0
                                });
                                markers.push(marker);
                                const infoWindow = new google.maps.InfoWindow({
                                    content: `<h3>${location.title}</h3>`
                                });
                                marker.addListener("click", () => {
                                    if (currentInfoWindow) {
                                        currentInfoWindow.close();
                                    }
                                    markers.forEach(m => {
                                        m.setIcon(defaultIcon);
                                        m.setZIndex(0);
                                    });
                                    marker.setIcon(enlargedIcon);
                                    marker.setZIndex(1000);
                                    currentMarker = marker;
                                    infoWindow.open(map, marker);
                                    currentInfoWindow = infoWindow;
                                    document.querySelectorAll("#table-body tr").forEach(row => {
                                        row.classList.remove("highlighted");
                                    });
                                    const row = document.getElementById(`row-${location.label}`);
                                    if (row) {
                                        row.classList.add("highlighted");
                                        const tableContainer = document.getElementById("table-container");
                                        setTimeout(() => {
                                            const headerHeight = document.querySelector("#locations-table thead").offsetHeight || 0;
                                            console.log("row.offsetTop:", row.offsetTop, "headerHeight:", headerHeight);
                                            tableContainer.scrollTop = row.offsetTop - headerHeight - 20;
                                        }, 300);
                                    }
                                });
                            }
                        });
                    }
                });

                map.addListener("click", () => {
                    if (currentInfoWindow) {
                        currentInfoWindow.close();
                        currentInfoWindow = null;
                    }
                    markers.forEach(m => {
                        m.setIcon(defaultIcon);
                        m.setZIndex(0);
                    });
                    currentMarker = null;
                    document.querySelectorAll("#table-body tr").forEach(row => {
                        row.classList.remove("highlighted");
                    });
                });

                const tableBody = document.getElementById("table-body");
                locations.forEach(location => {
                    const row = document.createElement("tr");
                    row.id = `row-${location.label}`;
                    row.innerHTML = `
                        <td>${location.label}</td>
                        <td>${location.address && typeof location.address === 'string' ? location.address : 'N/A'}</td>
                    `;
                    row.addEventListener("click", () => {
                        const marker = markers.find(m => m.label.text === location.label);
                        if (marker) {
                            if (currentInfoWindow) {
                                currentInfoWindow.close();
                            }
                            markers.forEach(m => {
                                m.setIcon(defaultIcon);
                                m.setZIndex(0);
                            });
                            marker.setIcon(enlargedIcon);
                            marker.setZIndex(1000);
                            currentMarker = marker;
                            const infoWindow = new google.maps.InfoWindow({
                                content: `<h3>${location.title}</h3>`
                            });
                            infoWindow.open(map, marker);
                            currentInfoWindow = infoWindow;
                            document.querySelectorAll("#table-body tr").forEach(r => {
                                r.classList.remove("highlighted");
                            });
                            row.classList.add("highlighted");
                            map.setCenter(marker.getPosition());
                        }
                    });
                    tableBody.appendChild(row);
                });
            };
        }

        initMap();
    </script>
</body>
</html>
